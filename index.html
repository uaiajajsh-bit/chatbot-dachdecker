<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat ‚Äì Dachdecker M√ºller</title>
<style>
  :root{
    --primary:#0056b3; /* neue Firmenfarbe Blau */
    --accent:#e7f0ff;
    --bubble-user:#dbe9ff;
    --bubble-bot:#ffffff;
    --muted:#555;
    --radius:14px;
    font-family:Inter, system-ui, Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%; margin:0; background:linear-gradient(180deg,#f2f6ff,#ffffff);}
  .chat-shell{width:380px; height:640px; display:flex; flex-direction:column; border-radius:18px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.12); background:#fff;}
  .chat-header{background:var(--primary); color:#fff; padding:14px 16px; display:flex; gap:10px; align-items:center}
  .brand h3{margin:0; font-size:15px; font-weight:600;}
  .brand p{margin:0; font-size:12px; opacity:0.9}
  .chat-body{flex:1; padding:16px; overflow:auto; background:linear-gradient(180deg,#f5f9ff,#fff)}
  .msg{max-width:78%; padding:10px 12px; margin-bottom:10px; border-radius:12px;}
  .msg.bot{background:var(--bubble-bot); align-self:flex-start; border-top-left-radius:4px}
  .msg.user{background:var(--bubble-user); align-self:flex-end; border-top-right-radius:4px}
  .muted{color:var(--muted); font-size:12px}
  .input-row{padding:12px; border-top:1px solid rgba(0,0,0,0.08); display:flex; gap:8px; align-items:center}
  input[type="text"]{flex:1; border:1px solid rgba(0,0,0,0.1); padding:10px 12px; border-radius:10px; font-size:14px}
  .btn{background:var(--primary); color:#fff; padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600}
  .chip{background:#eef3ff; padding:6px 8px; border-radius:999px; font-size:13px; color:var(--primary); border:1px solid rgba(0,0,0,0.05); cursor:pointer}
  .footer-note{padding:10px 14px; font-size:12px; color:var(--muted); border-top:1px dashed rgba(0,0,0,0.05)}
  @media (max-width:420px){.chat-shell{width:100%; height:100vh; border-radius:0}}
</style>
</head>
<body>

<div class="center" style="padding:20px;display:flex;justify-content:center;align-items:center;">
  <div class="chat-shell">
    <div class="chat-header">
      <img src="https://dachdecker-mueller.de/wp-content/themes/dachdecker-mueller/assets/images/logo.png" alt="Logo" style="height:40px;object-fit:contain;background:#fff;border-radius:6px;padding:4px;">
      <div class="brand">
        <h3>Dachdecker M√ºller GmbH</h3>
        <p>Digitaler Assistent ‚Äì Seehofstra√üe 60, 64653 Lorsch</p>
      </div>
    </div>

    <div class="chat-body" id="messages"></div>

    <div class="footer-note">
      Sie sprechen mit dem digitalen Assistenten von Dachdecker M√ºller.<br>Bei Bedarf meldet sich ein Dachdeckermeister pers√∂nlich.
    </div>

    <div class="input-row">
      <input id="userInput" type="text" placeholder="Wie k√∂nnen wir helfen? (z. B. Dachreparatur, Solar ‚Ä¶)" />
      <button id="sendBtn" class="btn">Senden</button>
    </div>

    <div style="padding:12px; border-top:1px solid rgba(0,0,0,0.05)">
      <button id="startBtn" class="chip">Start-Assistent</button>
      <button id="clearBtn" class="chip">Chat zur√ºcksetzen</button>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  COMPANY: "Dachdecker M√ºller GmbH",
  WEBHOOK_URL: "YOUR_WEBHOOK_URL_HERE",
  AUTO_REPLY_DELAY_MS: 600
};

const messagesEl=document.getElementById('messages');
const inputEl=document.getElementById('userInput');
const sendBtn=document.getElementById('sendBtn');
const startBtn=document.getElementById('startBtn');
const clearBtn=document.getElementById('clearBtn');

let conversation=JSON.parse(localStorage.getItem('dm_conversation')||'[]');
let lead=JSON.parse(localStorage.getItem('dm_lead')||'{}');

function renderMessages(){
  messagesEl.innerHTML='';
  conversation.forEach(m=>{
    const d=document.createElement('div');
    d.className='msg '+(m.from==='bot'?'bot':'user');
    d.innerHTML=`<div>${m.text}</div><div class="muted">${m.time}</div>`;
    messagesEl.appendChild(d);
  });
  messagesEl.scrollTop=messagesEl.scrollHeight;
}
function pushMessage(from,text){
  const t=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
  conversation.push({from,text,time:t});
  localStorage.setItem('dm_conversation',JSON.stringify(conversation));
  renderMessages();
}
function botReply(text){setTimeout(()=>pushMessage('bot',text),CONFIG.AUTO_REPLY_DELAY_MS);}

if(conversation.length===0){
  pushMessage('bot',`üëã Guten Tag ‚Äî ich bin Max, der digitale Assistent von ${CONFIG.COMPANY}. Wie kann ich Ihnen helfen?`);
}

function detectContactInfo(text){
  const phone=text.match(/(\+?\d[\d\s\/\-]{5,})/);
  const email=text.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
  if(email){lead.email=email[1];saveLead();botReply('Danke, ich habe Ihre E-Mail gespeichert. M√∂chten Sie mir auch Ihre Telefonnummer geben?');return true;}
  if(phone){lead.phone=phone[1];saveLead();botReply('Super, ich habe Ihre Telefonnummer notiert. Ein Dachdeckermeister meldet sich in K√ºrze.');return true;}
  return false;
}

function detectName(text){
  if(/ich hei√üe|mein name|name ist/i.test(text)){
    const parts=text.split(' ');
    const possible=parts.slice(-1)[0];
    if(possible && possible.length>2){lead.name=possible;saveLead();botReply(`Danke ${possible}! K√∂nnten Sie mir bitte noch Ihre Telefonnummer nennen?`);}
    return true;
  }
  return false;
}

function processUserInput(raw){
  const text=raw.trim();
  if(!text)return;
  pushMessage('user',text);
  if(detectContactInfo(text)||detectName(text))return;

  const lower=text.toLowerCase();
  if(/repar|sturm|undicht/.test(lower)){lead.service='Reparatur';saveLead();botReply('Verstanden ‚Äî eine Dachreparatur. Handelt es sich um ein Steildach oder Flachdach?');return;}
  if(/sanier|neu/.test(lower)){lead.service='Sanierung';saveLead();botReply('Okay, eine Sanierung. M√∂chten Sie eine Komplett- oder Teilsanierung?');return;}
  if(/solar|photovolta/.test(lower)){lead.service='Solar';saveLead();botReply('Prima ‚Äî f√ºr Solaranlagen arbeiten wir mit starken Partnern. Haben Sie bereits eine Anlage oder planen Sie neu?');return;}
  if(/fenster/.test(lower)){lead.service='Dachfenster';saveLead();botReply('Alles klar ‚Äî Dachfenster. M√∂chten Sie ein neues Fenster oder ein Austauschfenster?');return;}
  if(/termin|r√ºckruf/.test(lower)){lead.request='R√ºckruf';saveLead();botReply('Gerne. Bitte nennen Sie mir Ihren Namen und Ihre Telefonnummer.');return;}
  if(/start|fragebogen|assistent/.test(lower)){startAssistent();return;}

  botReply('Danke! K√∂nnen Sie mir bitte kurz sagen, ob es um eine Reparatur, Sanierung, Solaranlage oder Dachfenster geht?');
}

function saveLead(){localStorage.setItem('dm_lead',JSON.stringify(lead));}

sendBtn.onclick=()=>{
  const txt=inputEl.value;inputEl.value='';
  processUserInput(txt);
};
inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendBtn.click();}});

startBtn.onclick=startAssistent;
clearBtn.onclick=()=>{localStorage.clear();conversation=[];lead={};pushMessage('bot','Chat zur√ºckgesetzt. Wie kann ich Ihnen helfen?');};

function startAssistent(){
  pushMessage('user','Start-Assistent');
  botReply('Lassen Sie uns kurz die wichtigsten Punkte durchgehen:');
  setTimeout(()=>botReply('1Ô∏è‚É£ Worum geht es? (Reparatur, Sanierung, Solar, Dachfenster)'),700);
}

renderMessages();
</script>
</body>
</html>
